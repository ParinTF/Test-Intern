// server.js

// 1. IMPORT DEPENDENCIES à¹à¸¥à¸° MODULES à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
// ----------------------------------------------------------------
require('dotenv').config(); // à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ .env à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆ process.env à¹€à¸›à¹‡à¸™à¸­à¸±à¸™à¸”à¸±à¸šà¹à¸£à¸à¹€à¸ªà¸¡à¸­
const express = require('express');
const cors = require('cors');
const sequelize = require('./src/config/database'); // Import instance à¸‚à¸­à¸‡ sequelize à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§
const userRoutes = require('./src/routes/user.routes'); // Import router à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰

// Import Models à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Sequelize à¸£à¸¹à¹‰à¸ˆà¸±à¸à¹à¸¥à¸°à¸ªà¸²à¸¡à¸²à¸£à¸– sync à¹„à¸”à¹‰
require('./src/models/user.model'); 


// 2. INITIALIZE EXPRESS APP
// ----------------------------------------------------------------
const app = express();


// 3. CONFIGURE MIDDLEWARE
// ----------------------------------------------------------------
app.use(cors()); // à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰ Frontend (à¸ˆà¸²à¸à¸„à¸™à¸¥à¸° Origin) à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ API à¹„à¸”à¹‰
app.use(express.json()); // à¸—à¸³à¹ƒà¸«à¹‰ Express à¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¹à¸¥à¸°à¹à¸›à¸¥à¸‡ Request Body à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ JSON à¹„à¸”à¹‰ (à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š req.body)


// 4. DEFINE ROUTES
// ----------------------------------------------------------------
// Route à¸à¸·à¹‰à¸™à¸à¸²à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸² Server à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
app.get('/', (req, res) => {
  res.send('User Management API Server is running...');
});

// à¹ƒà¸Šà¹‰ User Routes à¸—à¸µà¹ˆà¹€à¸£à¸²à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸§à¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸¸à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ /api/users
// à¹€à¸Šà¹ˆà¸™ GET /api/users, POST /api/users/login
app.use('/api/users', userRoutes);


// 5. DATABASE CONNECTION & SERVER STARTUP
// ----------------------------------------------------------------
const PORT = process.env.PORT || 5000; // à¸”à¸¶à¸‡ Port à¸ˆà¸²à¸ .env à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰ 5000 à¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™

// sequelize.sync() à¸ˆà¸°à¸—à¸³à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Models à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ
// à¹€à¸£à¸²à¸ˆà¸°à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
sequelize
  .sync({ force: false }) // force: false à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡à¸ˆà¸°à¹„à¸¡à¹ˆà¸¥à¸šà¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸£à¸±à¸™
  .then(() => {
    console.log('âœ… Database synchronized successfully.');
    
    // à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§
    app.listen(PORT, () => {
      console.log(`ğŸš€ Server is running on port ${PORT}`);
    });
  })
  .catch((err) => {
    console.error('âŒ Unable to synchronize the database:', err);
  });